<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="bgapp">
    <!-- 根据类型获取文章 -->
    <resultMap id="postMap" type="post">
        <id column="post_id" property="postId"/>
        <result column="meta_key" property="metaKey"/>
        <result column="meta_value" property="metaValue"/>
        <result column="post_finished" property="postFinished"/>
        <result column="comment_count" property="commentCount"/>
        <result column="post_type" property="postType"/>
        <result column="post_status" property="postStatus"/>
        <result column="post_name" property="postSlug"/>
        <result column="post_title" property="postTitle"/>
        <result column="post_content" property="postContent"/>
        <result column="post_date" property="postDate"/>
        <result column="post_modified" property="postModified"/>
        <!-- 定义多对一关联信息（每个文章对应一个作者） -->
        <!-- <association property="sysUser" resultMap="userMap"/> -->
        <collection property="postMetas" ofType="postmeta" select="getPostMeta" column="post_id">
        </collection>
    </resultMap>
    <select id="getPostsByType" resultMap="postMap">
        SELECT p.post_id,p.post_finished,p.comment_count, p.post_status, p.post_type, p.post_name, p.post_title,p.post_content,p.post_date,p.post_modified,
        su.user_name,su.nick_name,su.user_profile,su.user_url,su.mobile,su.email,su.status,su.user_desc,su.user_registered,
        sr.id as role_id,sr.name as role_name,sr.cn_name
        FROM bg_posts p
        LEFT JOIN bg_postmeta pm ON pm.post_id = p.post_id
        LEFT JOIN sys_user su ON su.id = p.post_author
        LEFT JOIN sys_role_user sru on su.id= sru.sys_user_id
        LEFT JOIN sys_role sr on sru.sys_role_id = sr.id
        WHERE 1=1
        <if test="postStatus!=null and postStatus!=''">
            AND p.post_status = #{postStatus}
        </if>
        <if test="postType!=null and postType!=''">
            AND p.post_type = #{postType}
        </if>
        <if test="userId!=null">
            AND p.post_author = #{userId}
        </if>
        <if test="metaKey!=null and metaKey!=''">
            AND pm.meta_key = #{metaKey}
        </if>
        <if test="metaValue!=null and metaValue!=''">
            AND pm.meta_value = #{metaValue}
        </if>
        <if test="search!=null and search!=''">
            AND ((p.post_title LIKE concat(concat('%',#{search}),'%')) OR (p.post_content LIKE concat(concat('%',#{search}),'%')))
        </if>
        ORDER BY p.post_modified DESC
    </select>
    <!-- 获取文章属性 -->
    <select id="getPostMeta" resultType="postmeta">
        SELECT pm.meta_key as metaKey,ifnull(pm.meta_value, '文章') as metaValue
        FROM bg_postmeta pm
        WHERE pm.post_id = #{post_id}
    </select>
</mapper>